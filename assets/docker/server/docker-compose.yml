version: '3'

volumes:
    customer_postgres_data:
        driver: local
    keycloak_postgres_data:
        driver: local

services:
    postgres-customer-service:
        container_name: postgres-customer-service
        image: postgres:13.3
        volumes:
            - customer_postgres_data:/var/lib/postgresql/data
        environment:
            POSTGRES_DB: ${POSTGRES_DB}
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
        ports:
            - "5432:5432"

    postgres_for_keycloak:
        image: postgres:13.3
        volumes:
            - keycloak_postgres_data:/var/lib/postgresql/data
        environment:
            POSTGRES_DB: ${KEYCLOAK_POSTGRESQL_DB}
            POSTGRES_USER: ${KEYCLOAK_POSTGRESQL_USER}
            POSTGRES_PASSWORD: ${KEYCLOAK_POSTGRESQL_PASSWORD}

    keycloak:
        image: jboss/keycloak:13.0.1
        volumes:
            - ./keycloak_imports:/opt/jboss/keycloak/imports
        environment:
            DB_VENDOR: POSTGRES
            DB_ADDR: postgres_for_keycloak
            DB_DATABASE: ${KEYCLOAK_POSTGRESQL_DB}
            DB_SCHEMA: public
            DB_USER: ${KEYCLOAK_POSTGRESQL_USER}
            DB_PASSWORD: ${KEYCLOAK_POSTGRESQL_PASSWORD}
            KEYCLOAK_USER: ${KEYCLOAK_USER}
            KEYCLOAK_PASSWORD: ${KEYCLOAK_PASSWORD}
            KEYCLOAK_IMPORT: /opt/jboss/keycloak/imports/realm-szut.json
            KEYCLOAK_FRONTEND_URL: http://localhost:8080/auth
        ports:
            - 8080:8080
        depends_on:
            - postgres_for_keycloak

    customer-management-service:
        container_name: customer-management-service
        image: larmic/szut-customer-management-service:latest
        environment:
            spring.datasource.url: jdbc:postgresql://postgres-customer-service:5432/${POSTGRES_DB}
            spring.datasource.username: ${POSTGRES_USER}
            spring.datasource.password: ${POSTGRES_PASSWORD}
            keycloak.auth-server-url: http://keycloak:8080/auth
        ports:
            - "8083:8083"
        depends_on:
            - postgres-customer-service
            - postgres_for_keycloak
            - keycloak